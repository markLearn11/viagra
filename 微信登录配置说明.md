# 微信登录配置说明

## 概述

已成功实现微信登录功能，包括：
- 调用微信官方API获取真实的openid和session_key
- 支持开发模式和生产模式
- 完整的用户信息存储和更新

## 配置步骤

### 1. 获取微信小程序AppID和Secret

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入小程序后台
3. 开发 -> 开发管理 -> 开发设置
4. 复制 AppID (小程序ID)
5. 生成并复制 AppSecret (小程序密钥)

### 2. 配置后端环境变量

编辑 `backend/.env` 文件，修改以下配置：

```env
# 微信小程序配置
WECHAT_APPID=你的小程序AppID
WECHAT_SECRET=你的小程序AppSecret
```

### 3. 重启后端服务

配置完成后，重启后端服务使配置生效：

```bash
cd backend
python start.py
```

## 功能特性

### 后端实现

1. **真实微信API调用**
   - 调用 `https://api.weixin.qq.com/sns/jscode2session` 获取用户信息
   - 获取真实的 openid 和 session_key
   - 完整的错误处理和异常捕获

2. **开发模式支持**
   - 当微信API调用失败时，自动切换到开发模式
   - 生成临时的 openid 用于测试
   - 便于本地开发和调试

3. **用户信息管理**
   - 自动创建新用户或更新现有用户
   - 存储微信昵称、头像等信息
   - 支持session_key更新

### 前端实现

1. **标准微信登录流程**
   - 调用 `wx.login()` 获取临时登录凭证code
   - 调用 `wx.getUserProfile()` 获取用户授权信息
   - 将code和用户信息发送到后端验证

2. **用户体验优化**
   - 清晰的授权提示
   - 完整的错误处理
   - 登录成功后自动跳转

## 测试方法

### 开发环境测试

1. 在微信开发者工具中打开项目
2. 点击微信登录按钮
3. 查看控制台日志，确认API调用情况
4. 检查后端日志，确认用户创建/更新

### 生产环境测试

1. 配置正确的AppID和Secret
2. 在真机上测试微信登录
3. 确认用户信息正确获取和存储

## 注意事项

1. **AppSecret安全**
   - AppSecret是敏感信息，不要提交到代码仓库
   - 生产环境建议使用环境变量或密钥管理服务

2. **用户授权**
   - `wx.getUserProfile()` 需要用户主动点击授权
   - 每次调用都会弹出授权框
   - 建议在合适的时机引导用户授权

3. **网络环境**
   - 微信API调用需要网络连接
   - 开发环境可能因为网络问题调用失败
   - 已实现降级到开发模式的机制

4. **数据同步**
   - 用户信息会在每次登录时更新
   - session_key有有效期，需要定期更新
   - openid是用户的唯一标识，不会改变

## 故障排除

### 常见问题

1. **微信API调用失败**
   - 检查AppID和Secret是否正确
   - 确认网络连接正常
   - 查看后端日志获取详细错误信息

2. **用户授权失败**
   - 确认在真机或微信开发者工具中测试
   - 检查小程序是否已发布或设为体验版
   - 确认用户点击了授权按钮

3. **登录后跳转失败**
   - 检查前端路由配置
   - 确认目标页面存在且配置正确
   - 查看前端控制台错误信息

### 调试技巧

1. **查看后端日志**
   ```bash
   # 查看实时日志
   tail -f backend/logs/app.log
   ```

2. **前端调试**
   - 在微信开发者工具中查看Network面板
   - 检查API请求和响应
   - 查看Console面板的错误信息

3. **数据库检查**
   ```bash
   # 查看用户表
   sqlite3 backend/miniprogram.db "SELECT * FROM users WHERE wechat_openid IS NOT NULL;"
   ```