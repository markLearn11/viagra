<!-- pages/plan/plan.wxml -->
<view class="page">
  <!-- 自定义导航栏 -->
  <navbar title="" show-back-arrow="{{true}}" bind:leftIconTap="goBack" showRightIcon="{{false}}"></navbar>
  <view class="container">
    <view class="tab" data-active="{{tab}}">
      <view class="tab-item Ai {{tab === 'Ai' ? 'active' : ''}}" bindtap="onTabChange" data-tab="Ai">AI 小栖</view>
      <view class="tab-item {{tab === 'My' ? 'active' : ''}}" bindtap="onTabChange" data-tab="My">我的计划</view>
    </view>
    <view class="tab-content" wx:if="{{tab === 'My'}}">
      <view class="tab-content-week">
        <view class="tab-week-header">
          <view class="tab-title">本周计划达成</view>
          <view class="tab-tag">
            <image src="/static/images/medal.svg" />
            <text class="complate">{{weeklyStats.completed_count}}</text>
            <text class="unComplate">/</text>
            <text class="unComplate unComplateText">{{weeklyStats.total_count}}</text>
          </view>
        </view>
        <view class="tab-content-week-content">
          <!-- 默认显示一周视图 -->
          <view class="calendar-week">
            <view class="calendar-day {{item.status}}" wx:for="{{weekDays}}" wx:key="date" data-day="{{item.day}}" data-date="{{item.date}}" bindtap="onDayTap">
              <text class="day-number">{{item.day}}</text>
              <view class="day-status">
                <view wx:if="{{item.status === 'completed'}}" class="status-icon completed-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#7d6fff {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">✓</view>
                </view>
                <view wx:elif="{{item.status === 'warning'}}" class="status-icon warning-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#ff9500 {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">!</view>
                </view>
                <view wx:elif="{{item.status === 'overdue'}}" class="status-icon overdue-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#ffcc00 {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">!</view>
                </view>
                <view wx:elif="{{item.status === 'today'}}" class="status-icon today-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#007aff {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">今</view>
                </view>
                <view wx:elif="{{item.status === 'pending'}}" class="status-icon pending-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#999 {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">○</view>
                </view>
                <view wx:else class="status-icon empty-icon">
                  <view class="status-content"></view>
                </view>
              </view>
              <!-- 显示任务数量 -->
              <view class="task-count" wx:if="{{item.total > 0}}">{{item.completed}}/{{item.total}}</view>
            </view>
            <view class="expand-btn" bindtap="onExpandTap">
              <text class="expand-text">展开</text>
              <view class="expand-icon {{isExpanded ? 'expanded' : ''}}">▼</view>
            </view>
          </view>
        </view>
      </view>

      <view class="tab-content-today today-container">
        <view class="tab-content-today-header">
          <view class="tab-title">今日疗愈计划</view>
          <view class="tab-content-look" bindtap="onViewTodayPlan">
            查看
          </view>
        </view>
        <view class="today-plans-list">
          <view class="plan-item" wx:for="{{todayPlans}}" wx:key="id" data-index="{{index}}" bindtap="onPlanToggle">
            <view class="plan-checkbox {{item.completed ? 'completed' : ''}}">
              <view class="checkbox-icon" wx:if="{{item.completed}}">✓</view>
            </view>
            <text class="plan-text {{item.completed ? 'completed' : ''}}">{{item.text}}</text>
          </view>
        </view>
      </view>

      <view class="tab-content-all-plans all-plans-container">
        <view class="tab-content-today-header">
          <view class="tab-title">我的所有疗愈计划</view>
          <view class="tab-content-look">
            查看
          </view>
        </view>
        <view class="all-plans-list">
          <view class="all-plan-item" wx:for="{{allPlans}}" wx:key="id" data-index="{{index}}">
            <view class="all-plan-item-title">
              <view class="plan-number">计划{{index + 1}}:</view>
              <view class="plan-title">{{item.plan_name}}</view>
            </view>
            <view class="all-plan-item-detail">
              <view class="all-plan-tags">
                <view class="thirty-tag">三十天计划</view>
            
                <view wx:if="{{item.relationship}}" class="plan-relationship">{{item.relationship}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="tab-content-ai" wx:if="{{ tab === 'Ai' }}">
      <!-- 欢迎提示 -->
      <view class="welcome-tip" wx:if="{{!chatMessages.length}}">
        <view class="welcome-text-container">
         <view class="welcome-text">HI，我是你的心灵疗愈伙伴小栖</view>
         <span class="welcome-text-icon">😊</span>
        </view>
        <view class="welcome-text">在这里可以和我畅所欲言哦！</view>
      </view>
      
      <!-- 聊天消息列表 -->
      <scroll-view 
        class="chat-messages-container" 
        scroll-y="true" 
        scroll-top="{{scrollTop}}"
        wx:if="{{chatMessages.length > 0}}"
      >
        <view class="chat-messages">
          <view 
            class="message-item {{item.type}}" 
            wx:for="{{chatMessages}}" 
            wx:key="id"
          >
            <view class="message-content">
              <view class="message-bubble {{item.type}}">
                <text class="message-text">{{item.content}}</text>
                <view class="message-time">{{item.time}}</view>
              </view>
            </view>
          </view>
          
          <!-- 加载中提示 -->
          <view class="message-item ai" wx:if="{{isLoading}}">
            <view class="message-avatar">
              <view class="ai-avatar">小栖</view>
            </view>
            <view class="message-content">
              <view class="message-bubble ai loading">
                <text class="message-text">正在思考中...</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <!-- 聊天输入框 -->
      <view class="chat-input-container">
        <view class="input-wrapper">
          <input 
            class="chat-input" 
            placeholder="请输入你想说的话..." 
            value="{{inputValue}}"
            bindinput="onInputChange"
            confirm-type="send"
            bindconfirm="onSendMessage"
          />
          <view class="send-btn" bindtap="onSendMessage">
            <text class="send-text">发送</text>
          </view>
        </view>
      </view>
      
    </view>
  </view>
</view>