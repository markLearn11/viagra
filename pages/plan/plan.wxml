<!-- pages/plan/plan.wxml -->
<view class="page">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  -->
  <navbar title="" show-back-arrow="{{true}}" bind:leftIconTap="goBack" showRightIcon="{{false}}"></navbar>
  <view class="container">
    <view class="tab" data-active="{{tab}}">
      <view class="tab-item Ai {{tab === 'Ai' ? 'active' : ''}}" bindtap="onTabChange" data-tab="Ai">AI å°æ –</view>
      <view class="tab-item {{tab === 'My' ? 'active' : ''}}" bindtap="onTabChange" data-tab="My">æˆ‘çš„è®¡åˆ’</view>
    </view>
    <view class="tab-content" wx:if="{{tab === 'My'}}">
      <view class="tab-content-week">
        <view class="tab-week-header">
          <view class="tab-title">æœ¬å‘¨è®¡åˆ’è¾¾æˆ</view>
          <view class="tab-tag">
            <image src="/static/images/medal.svg" />
            <text class="complate">{{weeklyStats.completed_count}}</text>
            <text class="unComplate">/</text>
            <text class="unComplate unComplateText">{{weeklyStats.total_count}}</text>
          </view>
        </view>
        <view class="tab-content-week-content">
          <!-- é»˜è®¤æ˜¾ç¤ºä¸€å‘¨è§†å›¾ -->
          <view class="calendar-week">
            <view class="calendar-day {{item.status}}" wx:for="{{weekDays}}" wx:key="date" data-day="{{item.day}}" data-date="{{item.date}}" bindtap="onDayTap">
              <text class="day-number">{{item.day}}</text>
              <view class="day-status">
                <view wx:if="{{item.status === 'completed'}}" class="status-icon completed-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#7d6fff {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">âœ“</view>
                </view>
                <view wx:elif="{{item.status === 'warning'}}" class="status-icon warning-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#ff9500 {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">!</view>
                </view>
                <view wx:elif="{{item.status === 'overdue'}}" class="status-icon overdue-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#ffcc00 {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">!</view>
                </view>
                <view wx:elif="{{item.status === 'today'}}" class="status-icon today-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#007aff {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">ä»Š</view>
                </view>
                <view wx:elif="{{item.status === 'pending'}}" class="status-icon pending-icon progress-container">
                  <view class="progress-overlay" style="background: conic-gradient(#999 {{item.completed / item.total * 100}}%, transparent 0%)"></view>
                  <view class="status-content">â—‹</view>
                </view>
                <view wx:else class="status-icon empty-icon">
                  <view class="status-content"></view>
                </view>
              </view>
              <!-- æ˜¾ç¤ºä»»åŠ¡æ•°é‡ -->
              <view class="task-count" wx:if="{{item.total > 0}}">{{item.completed}}/{{item.total}}</view>
            </view>
            <view class="expand-btn" bindtap="onExpandTap">
              <text class="expand-text">å±•å¼€</text>
              <view class="expand-icon {{isExpanded ? 'expanded' : ''}}">â–¼</view>
            </view>
          </view>
        </view>
      </view>

      <view class="tab-content-today today-container">
        <view class="tab-content-today-header">
          <view class="tab-title">ä»Šæ—¥ç–—æ„ˆè®¡åˆ’</view>
          <view class="tab-content-look" bindtap="onViewTodayPlan">
            æŸ¥çœ‹
          </view>
        </view>
        <view class="today-plans-list">
          <view class="plan-item" wx:for="{{todayPlans}}" wx:key="id" data-index="{{index}}" bindtap="onPlanToggle">
            <view class="plan-checkbox {{item.completed ? 'completed' : ''}}">
              <view class="checkbox-icon" wx:if="{{item.completed}}">âœ“</view>
            </view>
            <text class="plan-text {{item.completed ? 'completed' : ''}}">{{item.text}}</text>
          </view>
        </view>
      </view>

      <view class="tab-content-all-plans all-plans-container">
        <view class="tab-content-today-header">
          <view class="tab-title">æˆ‘çš„æ‰€æœ‰ç–—æ„ˆè®¡åˆ’</view>
          <view class="tab-content-look">
            æŸ¥çœ‹
          </view>
        </view>
        <view class="all-plans-list">
          <view class="all-plan-item" wx:for="{{allPlans}}" wx:key="id" data-index="{{index}}">
            <view class="all-plan-item-title">
              <view class="plan-number">è®¡åˆ’{{index + 1}}:</view>
              <view class="plan-title">{{item.plan_name}}</view>
            </view>
            <view class="all-plan-item-detail">
              <view class="all-plan-tags">
                <view class="thirty-tag">ä¸‰åå¤©è®¡åˆ’</view>
            
                <view wx:if="{{item.relationship}}" class="plan-relationship">{{item.relationship}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="tab-content-ai" wx:if="{{ tab === 'Ai' }}">
      <!-- æ¬¢è¿æç¤º -->
      <view class="welcome-tip" wx:if="{{!chatMessages.length}}">
        <view class="welcome-text-container">
         <view class="welcome-text">HIï¼Œæˆ‘æ˜¯ä½ çš„å¿ƒçµç–—æ„ˆä¼™ä¼´å°æ –</view>
         <span class="welcome-text-icon">ğŸ˜Š</span>
        </view>
        <view class="welcome-text">åœ¨è¿™é‡Œå¯ä»¥å’Œæˆ‘ç•…æ‰€æ¬²è¨€å“¦ï¼</view>
      </view>
      
      <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
      <scroll-view 
        class="chat-messages-container" 
        scroll-y="true" 
        scroll-top="{{scrollTop}}"
        wx:if="{{chatMessages.length > 0}}"
      >
        <view class="chat-messages">
          <view 
            class="message-item {{item.type}}" 
            wx:for="{{chatMessages}}" 
            wx:key="id"
          >
            <view class="message-content">
              <view class="message-bubble {{item.type}}">
                <text class="message-text">{{item.content}}</text>
                <view class="message-time">{{item.time}}</view>
              </view>
            </view>
          </view>
          
          <!-- åŠ è½½ä¸­æç¤º -->
          <view class="message-item ai" wx:if="{{isLoading}}">
            <view class="message-avatar">
              <view class="ai-avatar">å°æ –</view>
            </view>
            <view class="message-content">
              <view class="message-bubble ai loading">
                <text class="message-text">æ­£åœ¨æ€è€ƒä¸­...</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <!-- èŠå¤©è¾“å…¥æ¡† -->
      <view class="chat-input-container">
        <view class="input-wrapper">
          <input 
            class="chat-input" 
            placeholder="è¯·è¾“å…¥ä½ æƒ³è¯´çš„è¯..." 
            value="{{inputValue}}"
            bindinput="onInputChange"
            confirm-type="send"
            bindconfirm="onSendMessage"
          />
          <view class="send-btn" bindtap="onSendMessage">
            <text class="send-text">å‘é€</text>
          </view>
        </view>
      </view>
      
    </view>
  </view>
</view>