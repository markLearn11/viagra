<!-- pages/plan/plan.wxml -->
<view class="page">
  <!-- 自定义导航栏 -->
  <navbar title="" show-back-arrow="{{true}}" bind:leftIconTap="goBack" showRightIcon="{{false}}"></navbar>
  <view class="container">
    <view class="tab" data-active="{{tab}}">
      <view class="tab-item Ai {{tab === 'Ai' ? 'active' : ''}}" bindtap="onTabChange" data-tab="Ai">AI 小栖</view>
      <view class="tab-item {{tab === 'My' ? 'active' : ''}}" bindtap="onTabChange" data-tab="My">我的计划</view>
    </view>
    <view class="tab-content" wx:if="{{tab === 'My'}}">
      <view class="tab-content-week">
        <view class="tab-week-header">
          <view class="tab-title">本周计划达成</view>
          <view class="tab-tag">
            <image src="/static/images/medal.svg" />
            <text class="complate">{{weeklyStats.completed_count}}</text>
            <text class="unComplate">/</text>
            <text class="unComplate unComplateText">{{weeklyStats.total_count}}</text>
          </view>
        </view>
        <view class="tab-content-week-content">
          <!-- 默认显示一周视图 -->
          <view class="calendar-week" wx:if="{{!isExpanded}}">
            <view class="calendar-day {{item.status}}" wx:for="{{weekDays}}" wx:key="date" data-day="{{item.day}}" data-date="{{item.date}}" bindtap="onDayTap">
              <text class="day-number">{{item.day}}</text>
              <view class="day-status">
                <view wx:if="{{item.status === 'completed'}}" class="status-icon completed-icon">✓</view>
                <view wx:elif="{{item.status === 'warning'}}" class="status-icon warning-icon">!</view>
                <view wx:elif="{{item.status === 'overdue'}}" class="status-icon overdue-icon">!</view>
                <view wx:elif="{{item.status === 'today'}}" class="status-icon today-icon">今</view>
                <view wx:elif="{{item.status === 'pending'}}" class="status-icon pending-icon">○</view>
                <view wx:else class="status-icon empty-icon"></view>
              </view>
              <!-- 显示任务数量 -->
              <view class="task-count" wx:if="{{item.total > 0}}">{{item.completed}}/{{item.total}}</view>
            </view>
            <view class="expand-btn" bindtap="onExpandTap">
              <text class="expand-text">展开</text>
              <view class="expand-icon">▼</view>
            </view>
          </view>
          
          <!-- 展开后显示最近三周的日期 -->
          <view class="calendar-expanded" wx:if="{{isExpanded}}">
            <view class="expanded-header">
              <text class="expanded-title">最近三周</text>
              <view class="collapse-btn" bindtap="onExpandTap">
                <text class="collapse-text">收起</text>
                <view class="collapse-icon">▲</view>
              </view>
            </view>
            <scroll-view class="calendar-scroll" scroll-y="true" style="height: 400rpx;">
              <view class="week-section" wx:for="{{allWeekDays}}" wx:key="weekName">
                <view class="week-header">
                  <text class="week-title">{{item.weekName}}</text>
                </view>
                <view class="calendar-grid">
                  <view class="calendar-day {{day.status}}" wx:for="{{item.days}}" wx:for-item="day" wx:key="date" data-day="{{day.day}}" data-date="{{day.date}}" bindtap="onDayTap">
                    <text class="day-number">{{day.day}}</text>
                    <view class="day-status">
                      <view wx:if="{{day.status === 'completed'}}" class="status-icon completed-icon">✓</view>
                      <view wx:elif="{{day.status === 'warning'}}" class="status-icon warning-icon">!</view>
                      <view wx:elif="{{day.status === 'overdue'}}" class="status-icon overdue-icon">!</view>
                      <view wx:elif="{{day.status === 'today'}}" class="status-icon today-icon">今</view>
                      <view wx:elif="{{day.status === 'pending'}}" class="status-icon pending-icon">○</view>
                      <view wx:else class="status-icon empty-icon"></view>
                    </view>
                    <!-- 显示任务数量 -->
                    <view class="task-count" wx:if="{{day.total > 0}}">{{day.completed}}/{{day.total}}</view>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
        </view>
      </view>

      <view class="tab-content-today today-container">
        <view class="tab-content-today-header">
          <view class="tab-title">今日疗愈计划</view>
          <view class="tab-content-look">
            查看
          </view>
        </view>
        <view class="today-plans-list">
          <view class="plan-item" wx:for="{{todayPlans}}" wx:key="id" data-index="{{index}}" bindtap="onPlanToggle">
            <view class="plan-checkbox {{item.completed ? 'completed' : ''}}">
              <view class="checkbox-icon" wx:if="{{item.completed}}">✓</view>
            </view>
            <text class="plan-text {{item.completed ? 'completed' : ''}}">{{item.text}}</text>
          </view>
        </view>
      </view>

      <view class="tab-content-all-plans all-plans-container">
        <view class="tab-content-today-header">
          <view class="tab-title">我的所有疗愈计划</view>
          <view class="tab-content-look">
            查看
          </view>
        </view>
        <view class="all-plans-list">
          <view class="all-plan-item" wx:for="{{allPlans}}" wx:key="id" data-index="{{index}}">
            <view class="all-plan-item-title">
              <view class="plan-number">计划{{index + 1}}:</view>
              <view class="plan-title">{{item.plan_name}}</view>
            </view>
            <view class="all-plan-item-detail">
              <view class="all-plan-tags">
                <view class="thirty-tag">三十天计划</view>
            
                <view wx:if="{{item.relationship}}" class="plan-relationship">{{item.relationship}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="tab-content-ai" wx:if="{{ tab === 'Ai' }}">
      <!-- 欢迎提示 -->
      <view class="welcome-tip" wx:if="{{!chatMessages.length}}">
        <view class="welcome-text-container">
         <view class="welcome-text">HI，我是你的心灵疗愈伙伴小栖</view>
         <span class="welcome-text-icon">😊</span>
        </view>
        <view class="welcome-text">在这里可以和我畅所欲言哦！</view>
      </view>
      
      <!-- 聊天消息列表 -->
      <scroll-view 
        class="chat-messages-container" 
        scroll-y="true" 
        scroll-top="{{scrollTop}}"
        wx:if="{{chatMessages.length > 0}}"
      >
        <view class="chat-messages">
          <view 
            class="message-item {{item.type}}" 
            wx:for="{{chatMessages}}" 
            wx:key="id"
          >
            <view class="message-content">
              <view class="message-bubble {{item.type}}">
                <text class="message-text">{{item.content}}</text>
                <view class="message-time">{{item.time}}</view>
              </view>
            </view>
          </view>
          
          <!-- 加载中提示 -->
          <view class="message-item ai" wx:if="{{isLoading}}">
            <view class="message-avatar">
              <view class="ai-avatar">小栖</view>
            </view>
            <view class="message-content">
              <view class="message-bubble ai loading">
                <text class="message-text">正在思考中...</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <!-- 聊天输入框 -->
      <view class="chat-input-container">
        <view class="input-wrapper">
          <input 
            class="chat-input" 
            placeholder="请输入你想说的话..." 
            value="{{inputValue}}"
            bindinput="onInputChange"
            confirm-type="send"
            bindconfirm="onSendMessage"
          />
          <view class="send-btn" bindtap="onSendMessage">
            <text class="send-text">发送</text>
          </view>
        </view>
      </view>
      
    </view>
  </view>
</view>