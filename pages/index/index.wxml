<!--index.wxml-->
<view class="page">
    <!-- 自定义导航栏 -->
    <navbar title="栖溯光屿" show-back-arrow="{{false}}" bind:leftIconTap="onLeftIconTap" bind:rightIconTap="onRightIconTap"></navbar>
    
    <!-- 抽屉组件 -->
    <drawer show="{{showDrawer}}" bind:close="onDrawerClose" bind:itemTap="onDrawerItemTap"></drawer>
    
    <!-- 欢迎界面 - 仅在未设置profile且未跳过时显示 -->
    <view class="welcome-section" wx:if="{{!hasProfile && showWelcome}}">
        <view class="container">
            <view>你好呀！欢迎来到栖溯，我是你的 AI 心理伙伴。</view>
            <view>在这里，你可以安全地倾诉烦恼，</view>
            <view>我会尽力帮你梳理思路，找到方向。</view>
            <view>为了更好地理解你并提供帮助，</view>
            <view>我们需要先简单认识一下，可以吗？（只需要2分钟）</view>
        </view>
        <view class="button">
            <view class="talk" bindtap="onSkipWelcome">稍后再说</view>
            <view class="begin" bindtap="onStartProfile">好的，开始</view>
        </view>
    </view>

    <!-- 个性化欢迎界面 - 设置profile后显示，直到有AI回复才隐藏 -->
    <view class="personalized-welcome" wx:if="{{(hasProfile && !hasAiReply) || waitAndSayFlag}}">
        <!-- 第1步：问题描述 -->
        <view wx:if="{{currentStep === 1}}">
            <view class="welcome-text">欢迎回来，{{userProfile.nickname || 'yuki'}}！</view>
            <view class="guide-text">首先，能和我详细说说让你感到伤心难过</view>
            <view class="guide-text">或烦恼的事情是什么吗？</view>
            <view class="example-text">例如 "我和TA吵架了，TA不理我了，我很难过"</view>
        </view>
        
        <!-- 第2步：关系类型询问 -->
        <view wx:if="{{currentStep === 2}}">
            <view class="step-title">听起来这件事涉及到其他人，</view>
            <view class="step-subtitle">能告诉我这个人（或这些人）和你是什么关系呢？</view>
            
            <!-- 快捷选择按钮（多选） -->
            <view class="quick-buttons" wx:if="{{showQuickButtons}}">
                <!-- 显示AI推荐的关系类型，如果没有则显示所有选项 -->
                <view class="quick-btn {{selectedRelationships.includes(item) ? 'selected' : ''}}" 
                      wx:for="{{relationshipsToShow}}" 
                      wx:key="item"
                      data-relation="{{item}}"
                      bindtap="onQuickSelectRelation">
                    {{item}}
                
                    <view class="check-icon" wx:if="{{selectedRelationships.includes(item)}}">✓</view>
                </view>
                 
                <!-- 确认选择按钮 -->
                <view class="confirm-selection-btn" 
                      wx:if="{{showConfirmButton}}"
                      bindtap="onConfirmRelationshipSelection">
                    确认选择 ({{selectedRelationships.length}})
                </view>
            </view>
        </view>
        
        <!-- 第3步：详细情况了解 -->
        <view wx:if="{{currentStep === 3}}">
            <view class="step-title">为了更好地理解你们之间的情况，</view>
            <view class="step-subtitle">能具体说说最近发生了什么事情吗？</view>
            <view class="step-subtitle">1. 你们关系的持续时长？</view>
            <view class="step-subtitle">2. 是什么时候发生的事情？</view>
            <view class="step-subtitle">3. 大致经过是怎么样的？</view>
            <view class="question-note">（尽量客观描述事实）</view>
        </view>
        
        <!-- 第4步：补充信息确认 -->
        <view wx:if="{{currentStep === 4}}">
            <view class="step-title">了解了，那么关于这件事，</view>
            <view class="step-subtitle">你还有什么需要补充的内容吗？</view>
            
            <!-- 选择按钮 -->
            <view class="choice-buttons">
                <view class="choice-btn" bindtap="onNoMoreInfo">没有了，我已经说完了</view>
                <view class="choice-btn" bindtap="onHasMoreInfo">有，我还有补充</view>
            </view>
        </view>
        
        <!-- 第5步：总结与理解确认 -->
        <view wx:if="{{currentStep === 5}}">
            <view class="step-title">那么，让我简单总结一下你告诉我的信息，</view>
            <view class="step-subtitle">看看我理解的对不对：</view>
            
            <!-- AI总结加载状态 -->
            <view wx:if="{{isLoading}}" class="summary-loading">
                <view class="loading-text">AI正在生成总结...</view>
            </view>
            
            <!-- AI生成的总结内容 -->
            <view wx:if="{{!isLoading && flowData.aiSummary}}" class="summary-content">
                <view class="summary-item" wx:if="{{flowData.aiSummary.problemSummary}}">
                    <text class="summary-label">问题描述：</text>
                    <text class="summary-text">{{flowData.aiSummary.problemSummary}}</text>
                </view>
                <view class="summary-item" wx:if="{{flowData.aiSummary.relationshipSummary}}">
                    <text class="summary-label">关系类型：</text>
                    <text class="summary-text">{{flowData.aiSummary.relationshipSummary}}</text>
                </view>
                <view class="summary-item" wx:if="{{flowData.aiSummary.incidentSummary}}">
                    <text class="summary-label">事件经过：</text>
                    <text class="summary-text">{{flowData.aiSummary.incidentSummary}}</text>
                </view>
                <view class="summary-item" wx:if="{{flowData.aiSummary.additionalSummary && flowData.aiSummary.additionalSummary !== '无'}}">
                    <text class="summary-label">补充信息：</text>
                    <text class="summary-text">{{flowData.aiSummary.additionalSummary}}</text>
                </view>
            </view>
            
            <!-- 降级显示原始内容（如果AI总结失败） -->
            <view wx:if="{{!isLoading && !flowData.aiSummary}}" class="summary-content">
                <view class="summary-item" wx:if="{{flowData.problemDescription}}">
                    <text class="summary-label">问题描述：</text>
                    <text class="summary-text">{{flowData.problemDescription}}</text>
                </view>
                <view class="summary-item" wx:if="{{flowData.relationshipType}}">
                    <text class="summary-label">关系类型：</text>
                    <text class="summary-text">{{flowData.relationshipType}}</text>
                </view>
                <view class="summary-item" wx:if="{{flowData.incidentProcess}}">
                    <text class="summary-label">事件经过：</text>
                    <text class="summary-text">{{flowData.incidentProcess}}</text>
                </view>
                <view class="summary-item" wx:if="{{flowData.additionalInfo}}">
                    <text class="summary-label">补充信息：</text>
                    <text class="summary-text">{{flowData.additionalInfo}}</text>
                </view>
            </view>
            
            <!-- 确认按钮 -->
            <view class="choice-buttons">
                <view class="choice-btn" bindtap="onConfirmSummary">对的，是这样的</view>
                <view class="choice-btn" bindtap="onCorrectSummary">不对，我需要纠正</view>
            </view>
        </view>
        
        <!-- 第6步：目标设定 -->
        <view wx:if="{{currentStep === 6}}">
            <view class="welcome-text">{{userProfile.nickname || 'yuki'}}，感谢你对我的信任，</view>
            <view class="analysis-text">那么以下是我对这些事情的分析</view>
            
            <!-- AI分析结果 -->
            <view wx:if="{{flowData.aiAnalysis}}" class="ai-analysis-content">
                <text class="analysis-result">{{flowData.aiAnalysis}}</text>
            </view>
            
            <!-- 加载状态 -->
            <view wx:if="{{isLoading}}" class="analysis-loading">
                <view class="analysis-dots">分析中...</view>
            </view>
            
            <view class="analysis-note">（分析仅供参考，不具有法律效应）</view>
            
            <view class="goal-question">
                <view class="goal-text">那么，通过这次的心理咨询，</view>
                <view class="goal-text">你希望达成什么样的目标呢？</view>
            </view>
            
            <!-- 目标选择按钮 -->
            <view class="goal-buttons">
                <view class="goal-btn primary" bindtap="onSelectTreatmentGoal">
                    我想走出困境，帮我制定治疗计划
                </view>
                <view class="goal-btn secondary" bindtap="onSelectEmotionalGoal">
                    我只想说出来，发泄一下情绪
                </view>
            </view>
        </view>
        
        <!-- 第8步：治疗计划显示和命名 -->
        <view wx:if="{{currentStep === 8}}">
            <view class="plan-title">为了帮助yuki尽快走出这段选择的困扰，</view>
            <view class="plan-subtitle">以下，是为你制定的1个月的疗愈计划，</view>
            <view class="plan-subtitle">希望yuki能跟着计划执行，</view>
            <view class="plan-subtitle">每日坚持打卡，不要气馁，加油！</view>
            
            <!-- 治疗计划内容显示 -->
            <view class="treatment-plan-container">
                <!-- 加载状态 -->
                <view wx:if="{{isLoading}}" class="plan-loading">
                    <view class="loading-dots">
                        <view class="dot"></view>
                        <view class="dot"></view>
                        <view class="dot"></view>
                    </view>
                    <text class="loading-text">正在为您制定专属治疗计划...</text>
                </view>
                
                <!-- 流式内容显示 -->
                <view wx:if="{{flowData.streamingContent && !flowData.treatmentPlan}}" class="streaming-content">
                    <text class="streaming-text">{{flowData.streamingContent}}</text>
                    <view class="streaming-cursor">|</view>
                </view>
                
                <!-- 完整治疗计划显示 -->
                <view wx:if="{{flowData.treatmentPlan}}" class="treatment-plan-content">
                    <!-- 如果是JSON格式的结构化数据 -->
                    <view wx:if="{{flowData.treatmentPlan.weeks}}" class="structured-plan">
                        <!-- 周计划 -->
                        <view class="weeks-container">
                            <view wx:for="{{flowData.treatmentPlan.weeks}}" wx:key="week" class="week-item">
                                <view class="week-header">
                                    <text class="week-title">第{{item.week}}周：{{item.title}}</text>
                                </view>
                                <view class="week-items">
                                    <view wx:for="{{item.items}}" wx:for-item="task" wx:key="*this" class="task-item">
                                        <view class="task-bullet">•</view>
                                        <text class="task-text">{{task}}</text>
                                    </view>
                                </view>
                            </view>
                        </view>
                        
                        <!-- 每日实践建议 -->
                        <view wx:if="{{flowData.treatmentPlan.dailyPractice}}" class="daily-practice">
                            <view class="section-title">每日实践建议</view>
                            <view class="practice-items">
                                <view wx:for="{{flowData.treatmentPlan.dailyPractice}}" wx:for-item="practice" wx:key="*this" class="practice-item">
                                    <view class="practice-bullet">✓</view>
                                    <text class="practice-text">{{practice}}</text>
                                </view>
                            </view>
                        </view>
                    </view>
                    
                    <!-- 如果是普通文本格式 -->
                    <view wx:else class="text-plan">
                        <text class="plan-text">{{flowData.treatmentPlan}}</text>
                    </view>
                </view>
            </view>
            
            <!-- 计划命名部分 -->
            <view wx:if="{{flowData.treatmentPlan && !isLoading}}" class="plan-naming">
                <view class="plan-question">
                    <view class="plan-text">那么，先为这个计划添加名称</view>
                </view>
                
                <view class="plan-input-container">
                    <input 
                        class="plan-input" 
                        placeholder="请输入计划名称" 
                        value="{{planName}}" 
                        bindinput="onPlanNameInput"
                        maxlength="20"
                    />
                </view>
                
                <view class="plan-button-container">
                    <button 
                        class="plan-confirm-btn {{planName ? 'active' : ''}}" 
                        bindtap="onConfirmPlanName"
                        disabled="{{!planName}}"
                    >
                        确认
                    </button>
                </view>
            </view>
        </view>
        
    </view>


    <view class="bottom_container">
      <view class="card" bindtap="goToProfile" wx:if="{{hasProfile && !hasAiReply}}">
        <image src="/static/images/card.svg"></image>
        <view class="bottom_text">我的档案</view>
      </view>
      
      <!-- 聊天输入区域 -->
      <view class="chat-input-container">
        <view class="input-wrapper">
          <input 
            class="chat-input" 
            placeholder="{{currentStep === 1 ? '请详细描述你的烦恼' : currentStep === 2 ? '请选择或输入关系类型' : currentStep === 3 ? '例如我和相恋 5 年的男朋友，上周因为结婚的事情，他说...' : currentStep === 4 ? '请输入补充信息，或选择上方按钮' : '请输入你的回复'}}" 
            placeholder-class="input-placeholder" 
            value="{{inputValue}}"
            bindfocus="onInputFocus" 
            bindblur="onInputBlur" 
            bindinput="onInputChange"
            bindconfirm="onInputConfirm"
            disabled="{{waitAndSayFlag || hasProfile  ? false: true}}"
          />
          <view class="send-btn {{( inputValue.trim() || isLoading || waitAndSayFlag || hasProfile) ? '' : 'disabled'}} {{isSending ? 'sending' : ''}}" bindtap="sendMessage" disabled="{{isLoading || !inputValue.trim() || (!hasProfile && showWelcome) || isSending}}">
            <text>{{isSending ? '发送中...' : '发送'}}</text>
          </view>
        </view>
        
        <!-- 功能按钮区域 -->
        <view class="action-buttons" wx:if="{{hasAiReply}}">
          <view class="action-btn" bindtap="clearMessages">
            <text>清空对话</text>
          </view>
          <view class="action-btn" bindtap="goToProfile" wx:if="{{hasProfile}}">
            <text>我的档案</text>
          </view>
        </view>
      </view>
      
      <view class="tip" wx:if="{{!hasAiReply}}">
        你也可以直接进行提问
      </view>
    </view>
</view>