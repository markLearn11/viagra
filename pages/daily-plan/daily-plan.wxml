<!-- 顶部导航 -->
<view class="header">
  <view class="back-btn" bindtap="onBack">
    <text class="back-icon">‹</text>
  </view>
  <view class="header-title">今日疗愈计划</view>
  <view class="refresh-btn" bindtap="onRefresh">
  </view>
</view>

<view class="container">

  <!-- 计划标题和统计 -->
  <view class="plan-header">
    <view class="plan-title">今日所有计划<text class="practicesLength">（{{ totalTaskCount}}）</text></view>
    <view class="today-plan-btn" bindtap="onViewAllPlans">
      <image src="/static/images/calendar.svg" class="btn-icon-image" />
      <text class="btn-text">查看所有计划</text>
    </view>
  </view>

  <!-- 治疗计划内容 -->
  <view class="plan-content">
    <!-- 加载状态 -->
    <view wx:if="{{isLoading}}" class="loading-container">
      <view class="loading-spinner"></view>
      <text class="loading-text">正在获取今日任务...</text>
    </view>
    
    <!-- 今日任务显示 - 卡片式布局 -->
    <view wx:elif="{{todayTasks}}" class="week-container">
      <view wx:for="{{todayTasks}}" wx:for-item="task" wx:for-index="index" wx:key="id" class="task-container">
        <view class="task-card">
           <view class="task-title">计划{{ index + 1}}: {{ task.plan_name }}</view>
        <view class="expand-btn" bindtap="toggleExpand" data-index="{{index}}">
            <text>{{expanded[index] ? '收起' : '展开'}}</text>
            <text class="arrow-icon {{expanded[index] ? 'expanded' : ''}}">▼</text>
        </view>
        </view>
        <view class="task-details" hidden="{{!expanded[index]}}">
          <view class="task-item">
            <radio class="task-radio" checked="{{task.completed}}" bindtap="toggleTaskStatus" data-task-id="{{task.id}}" data-index="{{index}}" />
          </view>
           <view class="task-item">
            <view class="task-details-title">
              {{ task.task_text }}
            </view>
            <view class="task-details-text">
            {{ task.week_info.title }}
          </view>
           </view>
        </view>
      </view>
    </view>
    
    
    <!-- 无任务状态 -->
    <view wx:else class="no-plan">
      <text class="no-plan-text">今日暂无疗愈任务</text>
      <view class="no-plan-tips">
        <text class="tips-text">请先创建治疗计划或点击刷新获取最新任务</text>
      </view>
    </view>
  </view>
</view>